name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  flatpak:
    if: vars.BUILD_FLATPAK == 'true'
    runs-on: ubuntu-latest
    needs: goreleaser
    steps:
      - uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --user --if-not-exists flathub \
            https://flathub.org/repo/flathub.flatpakrepo
          flatpak install --user -y --noninteractive flathub \
            org.freedesktop.Platform//24.08 \
            org.freedesktop.Sdk//24.08

      - name: Build emqutiti binary for Flatpak
        run: go build -o flatpak/emqutiti ./cmd/emqutiti

      - name: Build Flatpak repo
        run: |
          flatpak-builder --user --force-clean --repo=repo builddir \
            flatpak/io.github.marang.Emqutiti.yml

      - name: Build Flatpak bundle
        run: |
          flatpak build-bundle repo emqutiti.flatpak io.github.marang.Emqutiti \
            --runtime-repo=https://flathub.org/repo/flathub.flatpakrepo

      - name: Upload Flatpak artifact
        uses: actions/upload-artifact@v4
        with:
          name: emqutiti-flatpak
          path: emqutiti.flatpak

      - name: Upload Flatpak to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: emqutiti.flatpak
